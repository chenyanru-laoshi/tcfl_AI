import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, 
  Trash2, 
  Play, 
  Settings, 
  Save, 
  RefreshCw, 
  ArrowLeft, 
  CheckCircle, 
  Volume2,
  AlertCircle,
  XCircle,
  X,
  Palette,
  Loader2
} from 'lucide-react';

// --- é è¨­è³‡æ–™ (Default Data) ---
const DEFAULT_VOCAB = [
  { id: '1', emoji: 'ğŸ', text: 'è˜‹æœ', pinyin: 'PÃ­ngguÇ’', color: 'bg-red-100' },
  { id: '2', emoji: 'ğŸŒ', text: 'é¦™è•‰', pinyin: 'XiÄngjiÄo', color: 'bg-yellow-100' },
  { id: '3', emoji: 'ğŸ‡', text: 'è‘¡è„', pinyin: 'PÃºtÃ¡o', color: 'bg-purple-100' },
  { id: '4', emoji: 'ğŸ‰', text: 'è¥¿ç“œ', pinyin: 'XÄ«guÄ', color: 'bg-green-100' },
  { id: '5', emoji: 'ğŸŠ', text: 'æ©˜å­', pinyin: 'JÃºzi', color: 'bg-orange-100' },
  { id: '6', emoji: 'ğŸ¥›', text: 'ç‰›å¥¶', pinyin: 'NiÃºnÇi', color: 'bg-blue-100' },
  { id: '7', emoji: 'ğŸ', text: 'éºµåŒ…', pinyin: 'MiÃ nbÄo', color: 'bg-amber-100' },
  { id: '8', emoji: 'ğŸ¦', text: 'å†°æ·‡æ·‹', pinyin: 'BÄ«ngqÃ­lÃ­n', color: 'bg-pink-100' },
];

// --- æœ¬åœ°æ‹¼éŸ³å­—å…¸ (Fallback Dictionary) ---
const LOCAL_PINYIN_MAP = {
  'è˜‹æœ': 'PÃ­ngguÇ’', 'é¦™è•‰': 'XiÄngjiÄo', 'è‘¡è„': 'PÃºtÃ¡o', 'è¥¿ç“œ': 'XÄ«guÄ',
  'æ©˜å­': 'JÃºzi', 'ç‰›å¥¶': 'NiÃºnÇi', 'éºµåŒ…': 'MiÃ nbÄo', 'å†°æ·‡æ·‹': 'BÄ«ngqÃ­lÃ­n',
  'è²“': 'MÄo', 'ç‹—': 'GÇ’u', 'æ›¸': 'ShÅ«', 'è€å¸«': 'LÇoshÄ«', 'å­¸ç”Ÿ': 'XuÃ©shÄ“ng',
  'å­¸æ ¡': 'XuÃ©xiÃ o', 'è»Š': 'ChÄ“', 'é£›æ©Ÿ': 'FÄ“ijÄ«', 'ç´…': 'HÃ³ng', 'è—': 'LÃ¡n'
};

// --- æ‹¼éŸ³ç”Ÿæˆå·¥å…· ---
const getPinyin = async (text) => {
  if (LOCAL_PINYIN_MAP[text]) {
    return LOCAL_PINYIN_MAP[text];
  }
  try {
    const { pinyin } = await import('https://esm.sh/pinyin-pro');
    const result = pinyin(text, { toneType: 'symbol' });
    const formatted = result.replace(/\s+/g, '');
    return formatted.charAt(0).toUpperCase() + formatted.slice(1);
  } catch (error) {
    console.warn('ç„¡æ³•è¼‰å…¥ pinyin-proï¼Œä¸”æœ¬åœ°å­—å…¸æŸ¥ç„¡æ­¤å­—', error);
    return text;
  }
};

// --- é¡è‰²æ±  (ç”Ÿè©å¡ç‰‡ç”¨) ---
const COLOR_PALETTE = [
  'bg-red-100', 'bg-orange-100', 'bg-amber-100', 'bg-yellow-100', 
  'bg-lime-100', 'bg-green-100', 'bg-emerald-100', 'bg-teal-100', 
  'bg-cyan-100', 'bg-sky-100', 'bg-blue-100', 'bg-indigo-100', 
  'bg-violet-100', 'bg-purple-100', 'bg-fuchsia-100', 'bg-pink-100', 
  'bg-rose-100'
];

// --- èƒŒæ™¯é¢¨æ ¼è¨­å®š (Themes) ---
const THEME_OPTIONS = {
  default: { 
    id: 'default', 
    name: 'ç°¡ç´„ç™½æ¿', 
    bg: 'bg-slate-50', 
    text: 'text-slate-800', 
    accent: 'bg-white border-slate-200',
    preview: 'bg-slate-100'
  },
  wood: { 
    id: 'wood', 
    name: 'æº«æš–æœ¨è³ª', 
    bg: 'bg-orange-50', 
    text: 'text-amber-900', 
    accent: 'bg-orange-100 border-orange-200',
    preview: 'bg-orange-100'
  },
  ocean: { 
    id: 'ocean', 
    name: 'æµ·æ´‹æ¸…æ¶¼', 
    bg: 'bg-cyan-50', 
    text: 'text-cyan-900', 
    accent: 'bg-cyan-100 border-cyan-200',
    preview: 'bg-cyan-100'
  },
  forest: { 
    id: 'forest', 
    name: 'æ£®æ—ç¶ æ„', 
    bg: 'bg-lime-50', 
    text: 'text-lime-900', 
    accent: 'bg-lime-100 border-lime-200',
    preview: 'bg-lime-100'
  },
  dream: { 
    id: 'dream', 
    name: 'å¤¢å¹»ç´«ç¾…è˜­', 
    bg: 'bg-violet-50', 
    text: 'text-violet-900', 
    accent: 'bg-violet-100 border-violet-200',
    preview: 'bg-violet-100'
  },
};

// --- éŸ³æ•ˆå·¥å…· (Audio Helper) ---
const playSound = (type) => {
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!AudioContext) return;
  
  const ctx = new AudioContext();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  
  osc.connect(gain);
  gain.connect(ctx.destination);
  
  if (type === 'correct') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(600, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
    osc.start();
    osc.stop(ctx.currentTime + 0.3);
  } else if (type === 'wrong') {
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
    osc.start();
    osc.stop(ctx.currentTime + 0.3);
  } else if (type === 'win') {
    [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g);
      g.connect(ctx.destination);
      o.type = 'triangle';
      o.frequency.value = freq;
      g.gain.setValueAtTime(0.1, ctx.currentTime + i * 0.1);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.5);
      o.start(ctx.currentTime + i * 0.1);
      o.stop(ctx.currentTime + i * 0.1 + 0.6);
    });
  }
};

// --- èªéŸ³å·¥å…· (TTS Helper) ---
const speakText = (text) => {
  if (!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'zh-TW';
  utterance.rate = 0.9;
  window.speechSynthesis.speak(utterance);
};

export default function App() {
  const [mode, setMode] = useState('editor');
  const [vocabList, setVocabList] = useState([]);
  const [gridSize, setGridSize] = useState(4);
  const [diffCount, setDiffCount] = useState(5);
  const [currentThemeId, setCurrentThemeId] = useState('default');

  useEffect(() => {
    const savedVocab = localStorage.getItem('teacher-game-vocab');
    if (savedVocab) {
      setVocabList(JSON.parse(savedVocab));
    } else {
      setVocabList(DEFAULT_VOCAB);
    }
    const savedTheme = localStorage.getItem('teacher-game-theme');
    if (savedTheme && THEME_OPTIONS[savedTheme]) {
      setCurrentThemeId(savedTheme);
    }
  }, []);

  useEffect(() => {
    if (vocabList.length > 0) {
      localStorage.setItem('teacher-game-vocab', JSON.stringify(vocabList));
    }
  }, [vocabList]);

  useEffect(() => {
    localStorage.setItem('teacher-game-theme', currentThemeId);
  }, [currentThemeId]);

  const handleAddWord = (newWord) => {
    const randomColor = COLOR_PALETTE[Math.floor(Math.random() * COLOR_PALETTE.length)];
    const wordWithId = { 
      ...newWord, 
      id: Date.now().toString(),
      color: randomColor
    };
    setVocabList([...vocabList, wordWithId]);
  };

  const handleDeleteWord = (id) => {
    const updatedList = vocabList.filter(word => word.id !== id);
    setVocabList(updatedList);
  };

  const handleResetDefault = () => {
    if (window.confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è¶…å¸‚ç”Ÿè©å—ï¼Ÿç›®å‰çš„è‡ªè¨‚ç”Ÿè©å°‡æœƒæ¶ˆå¤±ã€‚')) {
      setVocabList(DEFAULT_VOCAB);
    }
  };

  return (
    <div className={`min-h-screen font-sans ${mode === 'editor' ? 'bg-slate-50 text-slate-800' : ''}`}>
      {mode === 'editor' ? (
        <EditorMode 
          vocabList={vocabList} 
          onAdd={handleAddWord} 
          onDelete={handleDeleteWord}
          onStartGame={() => setMode('game')}
          onReset={handleResetDefault}
          gridSize={gridSize}
          setGridSize={setGridSize}
          diffCount={diffCount}
          setDiffCount={setDiffCount}
          currentThemeId={currentThemeId}
          setThemeId={setCurrentThemeId}
        />
      ) : (
        <GameMode 
          vocabList={vocabList} 
          gridSize={gridSize} 
          diffCount={diffCount}
          themeId={currentThemeId}
          onBack={() => setMode('editor')} 
        />
      )}
    </div>
  );
}

function EditorMode({ 
  vocabList, onAdd, onDelete, onStartGame, onReset, 
  gridSize, setGridSize, diffCount, setDiffCount,
  currentThemeId, setThemeId 
}) {
  const [form, setForm] = useState({ emoji: '', text: '', pinyin: '' });
  const [error, setError] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!form.emoji || !form.text) {
      setError('è«‹è‡³å°‘è¼¸å…¥ Emoji å’Œå–®å­—');
      return;
    }

    let finalPinyin = form.pinyin;

    if (!finalPinyin) {
      setIsGenerating(true);
      try {
        finalPinyin = await getPinyin(form.text);
      } catch (err) {
        console.error("Pinyin generation error:", err);
        finalPinyin = form.text;
      }
      setIsGenerating(false);
    }

    onAdd({ ...form, pinyin: finalPinyin });
    setForm({ emoji: '', text: '', pinyin: '' });
    setError('');
  };

  const canStart = vocabList.length >= 4;

  return (
    <div className="container mx-auto max-w-4xl p-4 md:p-8">
      <header className="mb-8 text-center md:text-left flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2 justify-center md:justify-start">
            <Settings className="w-8 h-8 text-blue-600" />
            éŠæˆ²å‡ºé¡Œå™¨
          </h1>
          <p className="text-slate-500 mt-1">å»ºç«‹ç”Ÿè©åˆ—è¡¨ï¼Œè‡ªå‹•ç”Ÿæˆã€Œå¤§å®¶ä¾†æ‰¾ç¢´ã€éŠæˆ²</p>
        </div>
        
        <div className="flex gap-3">
           <button 
            onClick={onReset}
            className="flex items-center gap-2 px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors"
          >
            <RefreshCw size={18} /> é‡ç½®é è¨­
          </button>
          <button 
            onClick={onStartGame}
            disabled={!canStart}
            className={`flex items-center gap-2 px-6 py-2 rounded-lg font-bold shadow-lg transition-all transform hover:scale-105 ${
              canStart 
              ? 'bg-blue-600 hover:bg-blue-700 text-white' 
              : 'bg-slate-300 text-slate-500 cursor-not-allowed'
            }`}
          >
            <Play size={20} fill="currentColor" /> é–‹å§‹éŠæˆ²
          </button>
        </div>
      </header>

      {!canStart && (
        <div className="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 flex items-center gap-2">
          <AlertCircle size={20} />
          <span>ç”Ÿè©æ•¸é‡ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ 4 å€‹å–®å­—æ‰èƒ½é–‹å§‹éŠæˆ²ã€‚</span>
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
              <Plus className="w-5 h-5 text-green-600" /> æ–°å¢ç”Ÿè©
            </h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">Emoji / åœ–ç‰‡</label>
                <input 
                  type="text" 
                  placeholder="ä¾‹å¦‚ï¼šğŸ" 
                  className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-2xl text-center"
                  value={form.emoji}
                  onChange={e => setForm({...form, emoji: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">ä¸­æ–‡å–®å­—</label>
                <input 
                  type="text" 
                  placeholder="ä¾‹å¦‚ï¼šè˜‹æœ" 
                  className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  value={form.text}
                  onChange={e => setForm({...form, text: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">æ‹¼éŸ³ (ç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆ)</label>
                <input 
                  type="text" 
                  placeholder="ç•™ç©ºè‡ªå‹•è£œå…¨..." 
                  className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder:text-slate-300"
                  value={form.pinyin}
                  onChange={e => setForm({...form, pinyin: e.target.value})}
                />
              </div>
              {error && <p className="text-red-500 text-sm">{error}</p>}
              <button 
                type="submit" 
                disabled={isGenerating}
                className={`w-full py-2 rounded-lg font-medium transition-colors flex justify-center items-center gap-2 ${
                  isGenerating 
                  ? 'bg-slate-300 cursor-wait text-slate-500' 
                  : 'bg-green-500 hover:bg-green-600 text-white'
                }`}
              >
                {isGenerating ? (
                  <>
                    <Loader2 size={18} className="animate-spin" /> ç”Ÿæˆä¸­...
                  </>
                ) : (
                  'åŠ å…¥åˆ—è¡¨'
                )}
              </button>
            </form>
          </div>

          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
              <Settings className="w-5 h-5 text-slate-600" /> åƒæ•¸è¨­å®š
            </h2>
            <div className="space-y-6">
              <div>
                <label className="flex justify-between text-sm font-medium text-slate-600 mb-1">
                  <span>ç¶²æ ¼å¤§å°</span>
                  <span className="text-blue-600">{gridSize} x {gridSize}</span>
                </label>
                <input 
                  type="range" min="3" max="5" 
                  value={gridSize} 
                  onChange={(e) => setGridSize(Number(e.target.value))}
                  className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                />
              </div>
              <div>
                <label className="flex justify-between text-sm font-medium text-slate-600 mb-1">
                  <span>å·®ç•°æ•¸é‡ (é¡Œç›®æ•¸)</span>
                  <span className="text-blue-600">{diffCount} å€‹</span>
                </label>
                <input 
                  type="range" min="1" max={Math.min(10, vocabList.length)} 
                  value={diffCount} 
                  onChange={(e) => setDiffCount(Number(e.target.value))}
                  className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                />
                <p className="text-xs text-slate-400 mt-1">æœ€å¤§å€¼å—é™æ–¼ç›®å‰çš„ç”Ÿè©ç¸½æ•¸</p>
              </div>
              
              <div>
                 <label className="flex items-center gap-2 text-sm font-medium text-slate-600 mb-3">
                  <Palette size={16} /> èƒŒæ™¯é¢¨æ ¼
                </label>
                <div className="grid grid-cols-5 gap-2">
                  {Object.values(THEME_OPTIONS).map(theme => (
                    <button
                      key={theme.id}
                      onClick={() => setThemeId(theme.id)}
                      title={theme.name}
                      className={`
                        w-full aspect-square rounded-full border-2 transition-all
                        ${theme.preview} 
                        ${currentThemeId === theme.id ? 'border-blue-500 scale-110 shadow-md' : 'border-transparent hover:scale-105'}
                      `}
                    />
                  ))}
                </div>
                <div className="text-center mt-2 text-sm text-slate-500 font-medium">
                  {THEME_OPTIONS[currentThemeId].name}
                </div>
              </div>

            </div>
          </div>
        </div>

        <div className="lg:col-span-2">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-slate-700">ç›®å‰é¡Œåº« ({vocabList.length})</h2>
          </div>
          
          {vocabList.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-64 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 bg-slate-50">
              <p>ç›®å‰æ²’æœ‰ç”Ÿè©ï¼Œè«‹å¾å·¦å´æ–°å¢</p>
            </div>
          ) : (
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
              {vocabList.map((word) => (
                <div key={word.id} className={`relative group p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col items-center transition-transform hover:-translate-y-1 ${word.color}`}>
                  <button 
                    onClick={() => onDelete(word.id)}
                    className="absolute top-2 right-2 p-1 bg-white/50 hover:bg-red-500 hover:text-white rounded-full transition-colors opacity-0 group-hover:opacity-100"
                    title="åˆªé™¤"
                  >
                    <Trash2 size={14} />
                  </button>
                  <span className="text-4xl mb-2">{word.emoji}</span>
                  <span className="font-bold text-slate-800">{word.text}</span>
                  <span className="text-xs text-slate-500">{word.pinyin}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

function VocabularyCard({ word, type, onClose }) {
  if (!word) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200" onClick={onClose}>
      <div 
        className="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full mx-4 relative transform scale-100 animate-in zoom-in duration-200"
        onClick={e => e.stopPropagation()} 
      >
        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors">
          <X size={24} />
        </button>

        <div className="flex flex-col items-center text-center">
          {type === 'correct' ? (
             <div className="mb-4 text-green-500 bg-green-100 p-3 rounded-full">
               <CheckCircle size={32} />
             </div>
          ) : (
            <div className="mb-4 text-orange-500 bg-orange-100 p-3 rounded-full">
               <AlertCircle size={32} />
             </div>
          )}

          <div className={`w-32 h-32 flex items-center justify-center rounded-2xl mb-6 text-7xl ${word.color}`}>
            {word.emoji}
          </div>

          <h2 className="text-4xl font-bold text-slate-800 mb-2">{word.text}</h2>
          <p className="text-xl text-slate-500 mb-6 font-medium">{word.pinyin}</p>

          {type === 'wrong' && (
            <p className="text-orange-500 font-bold mb-4 bg-orange-50 px-4 py-2 rounded-lg">
              é€™è£¡ä¸€æ¨£å–”ï¼
            </p>
          )}

          <button 
            onClick={() => speakText(word.text)}
            className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-bold shadow-lg shadow-blue-200 transition-all hover:scale-105 active:scale-95"
          >
            <Volume2 size={20} /> å†æ¬¡ç™¼éŸ³
          </button>
        </div>
      </div>
    </div>
  );
}

function GameMode({ vocabList, gridSize, diffCount, onBack, themeId }) {
  const [leftGrid, setLeftGrid] = useState([]);
  const [rightGrid, setRightGrid] = useState([]);
  const [foundIndices, setFoundIndices] = useState([]);
  const [diffIndices, setDiffIndices] = useState([]);
  const [isWin, setIsWin] = useState(false);
  const [activeCard, setActiveCard] = useState(null); 
  const [wrongAnimIndex, setWrongAnimIndex] = useState(null);
  // æ–°å¢ç‹€æ…‹ï¼šè¨˜éŒ„éŒ¯èª¤ç™¼ç”Ÿåœ¨å“ªä¸€é‚Š ('left' æˆ– 'right')ï¼Œä»¥ä¾¿åªåœ¨è©²å´æ’­æ”¾å‹•ç•«
  const [wrongAnimSide, setWrongAnimSide] = useState(null);

  const theme = THEME_OPTIONS[themeId] || THEME_OPTIONS.default;

  useEffect(() => {
    initGame();
  }, []);

  const initGame = () => {
    setIsWin(false);
    setFoundIndices([]);
    setActiveCard(null);
    setWrongAnimSide(null);
    const totalCells = gridSize * gridSize;

    const baseGrid = Array.from({ length: totalCells }, () => {
      const randomWord = vocabList[Math.floor(Math.random() * vocabList.length)];
      return { ...randomWord };
    });
    setLeftGrid(baseGrid);

    const modifiedGrid = JSON.parse(JSON.stringify(baseGrid));
    const indicesToChange = new Set();
    while (indicesToChange.size < diffCount && indicesToChange.size < totalCells) {
      indicesToChange.add(Math.floor(Math.random() * totalCells));
    }
    
    const diffs = Array.from(indicesToChange);
    setDiffIndices(diffs);

    diffs.forEach(index => {
      const originalWord = modifiedGrid[index];
      let newWord;
      do {
        newWord = vocabList[Math.floor(Math.random() * vocabList.length)];
      } while (newWord.text === originalWord.text && vocabList.length > 1);
      
      modifiedGrid[index] = { ...newWord, isDifferent: true };
    });

    setRightGrid(modifiedGrid);
  };

  const handleCardClick = (index, isRightSide, word) => {
    if (isWin || activeCard) return; 

    speakText(word.text);

    // ä¿®æ”¹ï¼šåªè¦é»æ“Šçš„ä½ç½®æ˜¯å·®ç•°é» (diffIndices åŒ…å« index)ï¼Œä¸è«–å·¦å³éƒ½ç®—å°
    if (diffIndices.includes(index)) {
      if (!foundIndices.includes(index)) {
        playSound('correct');
        const newFound = [...foundIndices, index];
        setFoundIndices(newFound);
        setActiveCard({ word, type: 'correct' });
      } else {
        setActiveCard({ word, type: 'correct' });
      }
    } else {
      // é»éŒ¯äº† (é»åˆ°ä¸€æ¨£çš„)
      playSound('wrong');
      // è¨­å®šéŒ¯èª¤å‹•ç•«çš„ Index å’Œ Side
      setWrongAnimIndex(index);
      setWrongAnimSide(isRightSide ? 'right' : 'left');
      
      setTimeout(() => {
        setWrongAnimIndex(null);
        setWrongAnimSide(null);
      }, 1000);
      
      setActiveCard({ word, type: 'wrong' });
    }
  };

  const handleCloseCard = () => {
    setActiveCard(null);
    if (foundIndices.length === diffIndices.length && diffIndices.length > 0) {
      setTimeout(() => {
        playSound('win');
        setIsWin(true);
      }, 300);
    }
  };

  return (
    <div className={`flex flex-col h-screen overflow-hidden ${theme.bg}`}>
      {activeCard && (
        <VocabularyCard 
          word={activeCard.word} 
          type={activeCard.type} 
          onClose={handleCloseCard} 
        />
      )}

      <div className="bg-white/80 backdrop-blur-sm shadow-sm p-4 flex justify-between items-center z-10 border-b border-slate-100">
        <button 
          onClick={onBack}
          className={`flex items-center gap-2 font-medium transition-colors ${theme.text} hover:opacity-75`}
        >
          <ArrowLeft size={20} /> è¿”å›ç·¨è¼¯
        </button>
        <div className="flex items-center gap-4">
          <div className="bg-blue-100 text-blue-800 px-4 py-1 rounded-full text-sm font-bold">
            é€²åº¦: {foundIndices.length} / {diffIndices.length}
          </div>
          <button 
            onClick={initGame}
            className={`p-2 rounded-full hover:bg-black/5 transition-colors ${theme.text}`}
            title="é‡æ–°é–‹å§‹"
          >
            <RefreshCw size={20} />
          </button>
        </div>
      </div>

      <div className="flex-1 overflow-y-auto p-4 flex flex-col items-center justify-center">
        <div className="mb-6 text-center">
          <h2 className={`text-2xl font-bold mb-2 ${theme.text}`}>æ‰¾å‡ºå…©é‚Šä¸ä¸€æ¨£çš„åœ°æ–¹ï¼</h2>
          <p className={`${theme.text} opacity-70 flex items-center justify-center gap-2`}>
            <Volume2 size={16} /> é»æ“Šåœ–ç¤ºè½ç™¼éŸ³
          </p>
        </div>

        <div className="flex flex-col md:flex-row gap-8 items-center justify-center w-full max-w-6xl">
          <div className="relative">
            <div className={`absolute -top-8 left-0 font-bold text-sm tracking-widest uppercase opacity-50 ${theme.text}`}>Original</div>
            <Grid 
              items={leftGrid} 
              gridSize={gridSize} 
              onItemClick={(idx, item) => handleCardClick(idx, false, item)}
              highlightIndices={foundIndices}
              // ä¿®æ”¹ï¼šé–‹å•Ÿ ReviewModeï¼Œè®“å·¦å´ä¹Ÿèƒ½é¡¯ç¤ºç¶ è‰²æ‰“å‹¾
              isReviewMode={true}
              // ä¿®æ”¹ï¼šæ ¹æ“š wrongAnimSide æ±ºå®šæ˜¯å¦å‚³å…¥ wrongAnimIndex
              wrongAnimIndex={wrongAnimSide === 'left' ? wrongAnimIndex : null} 
            />
          </div>

          <div className={`hidden md:block w-px h-64 ${theme.text} opacity-20`}></div>

          <div className="relative">
             <div className="absolute -top-8 left-0 text-blue-500 font-bold text-sm tracking-widest uppercase">Spot Differences</div>
             <Grid 
              items={rightGrid} 
              gridSize={gridSize} 
              onItemClick={(idx, item) => handleCardClick(idx, true, item)}
              highlightIndices={foundIndices}
              isReviewMode={true}
              wrongAnimIndex={wrongAnimSide === 'right' ? wrongAnimIndex : null}
            />
          </div>
        </div>
      </div>

      {isWin && !activeCard && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-in fade-in duration-300">
          <div className="bg-white p-8 rounded-3xl shadow-2xl text-center transform scale-100 animate-in zoom-in duration-300 max-w-sm w-full mx-4">
            <div className="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <CheckCircle size={48} />
            </div>
            <h2 className="text-3xl font-bold text-slate-800 mb-2">å¤ªæ£’äº†ï¼</h2>
            <p className="text-slate-500 mb-8">ä½ æ‰¾åˆ°äº†æ‰€æœ‰ä¸åŒä¹‹è™•ï¼</p>
            <div className="flex flex-col gap-3">
              <button 
                onClick={initGame}
                className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 transition-all"
              >
                å†ç©ä¸€æ¬¡
              </button>
              <button 
                onClick={onBack}
                className="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-medium transition-colors"
              >
                å›åˆ°ç·¨è¼¯å™¨
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function Grid({ items, gridSize, onItemClick, highlightIndices, isReviewMode, wrongAnimIndex }) {
  const gridColsClass = {
    3: 'grid-cols-3',
    4: 'grid-cols-4',
    5: 'grid-cols-5',
  }[gridSize] || 'grid-cols-4';

  return (
    <div className={`grid ${gridColsClass} gap-3 bg-white/60 backdrop-blur-sm p-3 rounded-2xl shadow-xl border-4 border-white/50 select-none`}>
      {items.map((item, index) => {
        const isFound = highlightIndices.includes(index);
        const isWrong = wrongAnimIndex === index;
        
        return (
          <div 
            key={index}
            onClick={() => onItemClick(index, item)}
            className={`
              relative flex flex-col items-center justify-center 
              w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 
              rounded-xl cursor-pointer transition-all duration-200
              ${item.color} 
              active:scale-95 hover:brightness-95
              ${isFound && isReviewMode ? 'ring-4 ring-green-500 ring-offset-2 z-10' : ''}
              ${isWrong ? 'ring-4 ring-red-500 ring-offset-2 z-10 animate-pulse' : ''}
            `}
          >
            <span className="text-3xl sm:text-4xl md:text-5xl filter drop-shadow-sm">{item.emoji}</span>
            
            {isFound && isReviewMode && (
               <div className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full p-1 shadow-sm animate-in zoom-in duration-300">
                 <CheckCircle size={20} />
               </div>
            )}

            {isWrong && (
              <div className="absolute inset-0 flex items-center justify-center bg-red-500/20 rounded-xl animate-in fade-in zoom-in duration-200">
                 <XCircle size={48} className="text-red-600 opacity-80" />
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}
