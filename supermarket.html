import React, { useState, useEffect, useCallback, useRef } from 'react';
import { RefreshCw, Trophy, Volume2, Play, CheckCircle2, AlertCircle, Sparkles } from 'lucide-react';

// --- è³‡æ–™è¨­å®š (Vocabulary Data) ---
const VOCABULARY = [
  { id: 1, emoji: 'ğŸŸ', zh: 'é­š', pinyin: 'YÃº', bg: 'bg-blue-200' },
  { id: 2, emoji: 'ğŸ¥©', zh: 'ç‰›è‚‰', pinyin: 'NiÃº RÃ²u', bg: 'bg-red-200' },
  { id: 3, emoji: 'ğŸ«', zh: 'å·§å…‹åŠ›', pinyin: 'QiÇo KÃ¨ LÃ¬', bg: 'bg-amber-200' },
  { id: 4, emoji: 'ğŸ¦', zh: 'å†°æ·‡æ·‹', pinyin: 'BÄ«ng QÃ­ LÃ­n', bg: 'bg-pink-200' },
  { id: 5, emoji: 'ğŸš', zh: 'ç±³', pinyin: 'MÇ', bg: 'bg-slate-200' },
  { id: 6, emoji: 'ğŸ¥¬', zh: 'é’èœ', pinyin: 'QÄ«ng CÃ i', bg: 'bg-green-200' },
  { id: 7, emoji: 'ğŸ¬', zh: 'ç³–æœ', pinyin: 'TÃ¡ng GuÇ’', bg: 'bg-purple-200' },
];

// --- éŸ³æ•ˆç®¡ç†å™¨ (Audio Context) ---
const playSound = (type) => {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.connect(gain);
    gain.connect(ctx.destination);

    if (type === 'correct') {
      // å®å’š (å…©æ®µé«˜éŸ³)
      osc.type = 'sine';
      osc.frequency.setValueAtTime(660, ctx.currentTime);
      osc.frequency.setValueAtTime(880, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
      osc.start();
      osc.stop(ctx.currentTime + 0.5);
    } else if (type === 'wrong') {
      // å—¡å—¡ (ä½é »é‹¸é½’æ³¢)
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(150, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
      osc.start();
      osc.stop(ctx.currentTime + 0.3);
    } else if (type === 'win') {
      // å‹åˆ©éŸ³æ•ˆ (ç¶éŸ³)
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(440, ctx.currentTime);
      osc.frequency.setValueAtTime(554, ctx.currentTime + 0.1);
      osc.frequency.setValueAtTime(659, ctx.currentTime + 0.2);
      osc.frequency.setValueAtTime(880, ctx.currentTime + 0.3);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.8);
      osc.start();
      osc.stop(ctx.currentTime + 0.8);
    }
  } catch (e) {
    console.error("Audio play failed", e);
  }
};

// --- èªéŸ³æœ—è®€å‡½å¼ ---
const speakText = (text) => {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel(); // åœæ­¢ä¹‹å‰çš„ç™¼éŸ³
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-TW';
    utterance.rate = 0.8; // ç¨å¾®æ”¾æ…¢èªé€Ÿé©åˆå…’ç«¥
    window.speechSynthesis.speak(utterance);
  }
};

// --- ä¸»å…ƒä»¶ ---
export default function SupermarketDifferenceGame() {
  const [gameState, setGameState] = useState('start'); // 'start', 'playing', 'won'
  const [leftGrid, setLeftGrid] = useState([]);
  const [rightGrid, setRightGrid] = useState([]);
  const [diffIndices, setDiffIndices] = useState([]); // æ­£ç¢ºç­”æ¡ˆçš„ç´¢å¼•é›†åˆ
  const [foundIndices, setFoundIndices] = useState([]); // å·²ç¶“æ‰¾åˆ°çš„ç´¢å¼•
  const [activeCard, setActiveCard] = useState(null); // ç•¶å‰å½ˆå‡ºçš„ç”Ÿè©å¡
  const [feedbackMsg, setFeedbackMsg] = useState(''); // éŒ¯èª¤æç¤ºè¨Šæ¯
  const [shakeIndex, setShakeIndex] = useState(null); // ç”¨æ–¼è§¸ç™¼éŒ¯èª¤å‹•ç•«

  // éŠæˆ²åˆå§‹åŒ–é‚è¼¯
  const initGame = useCallback(() => {
    // 1. ç”Ÿæˆ 4x4 (16æ ¼) çš„åŸºç¤ç¶²æ ¼
    const baseGrid = Array.from({ length: 16 }, () => {
      const randomItem = VOCABULARY[Math.floor(Math.random() * VOCABULARY.length)];
      return { ...randomItem, instanceId: Math.random() }; // instanceId ç”¨æ–¼ React key
    });

    // 2. è¤‡è£½ä¸€ä»½çµ¦å³é‚Š
    const modifiedGrid = [...baseGrid];

    // 3. éš¨æ©Ÿé¸æ“‡ 5 å€‹ä½ç½®é€²è¡Œæ›¿æ›
    const indices = Array.from({ length: 16 }, (_, i) => i);
    // Fisher-Yates shuffle éƒ¨åˆ†å¯¦ä½œä¾†å–å‰ 5 å€‹
    for (let i = indices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    const targetIndices = indices.slice(0, 5);

    // 4. æ›¿æ›é€™ 5 å€‹ä½ç½®çš„å•†å“ï¼Œç¢ºä¿ä¸ä¸€æ¨£
    targetIndices.forEach(index => {
      const currentItem = modifiedGrid[index];
      let newItem;
      do {
        newItem = VOCABULARY[Math.floor(Math.random() * VOCABULARY.length)];
      } while (newItem.id === currentItem.id);
      
      modifiedGrid[index] = { ...newItem, instanceId: Math.random() };
    });

    setLeftGrid(baseGrid);
    setRightGrid(modifiedGrid);
    setDiffIndices(targetIndices);
    setFoundIndices([]);
    setGameState('playing');
    setActiveCard(null);
    setFeedbackMsg('');
  }, []);

  // é»æ“Šæ ¼å­è™•ç†
  const handleGridClick = (index) => {
    if (gameState !== 'playing' || activeCard) return;

    // æƒ…æ³ A: é»æ“Šäº†æ­£ç¢ºçš„ä¸åŒè™•
    if (diffIndices.includes(index)) {
      if (foundIndices.includes(index)) return; // å·²ç¶“æ‰¾éäº†

      playSound('correct');
      const item = rightGrid[index];
      
      // æ›´æ–°ç‹€æ…‹
      const newFound = [...foundIndices, index];
      setFoundIndices(newFound);
      
      // å½ˆå‡ºå¡ç‰‡ä¸¦æœ—è®€
      setActiveCard(item);
      speakText(item.zh);

      // æª¢æŸ¥æ˜¯å¦ç²å‹
      if (newFound.length === 5) {
        setTimeout(() => {
          playSound('win');
          setGameState('won');
          setActiveCard(null);
        }, 1500); // ç¨å¾®å»¶é²è®“ç©å®¶çœ‹å®Œæœ€å¾Œä¸€å¼µå¡
      }
    } 
    // æƒ…æ³ B: é»æ“Šäº†ç›¸åŒçš„åœ°æ–¹ï¼ˆéŒ¯èª¤ï¼‰
    else {
      playSound('wrong');
      setShakeIndex(index);
      setFeedbackMsg('é€™è£¡ä¸€æ¨£å–”ï¼å†ä»”ç´°çœ‹çœ‹ ğŸ‘€');
      setTimeout(() => setShakeIndex(null), 500);
      setTimeout(() => setFeedbackMsg(''), 1500);
    }
  };

  // é—œé–‰ç”Ÿè©å¡
  const closeCard = () => {
    setActiveCard(null);
  };

  // --- æ¸²æŸ“éƒ¨åˆ† ---

  // 1. é–‹å§‹ç•«é¢
  if (gameState === 'start') {
    return (
      <div className="min-h-screen bg-yellow-50 flex flex-col items-center justify-center p-4">
        <div className="bg-white p-8 rounded-3xl shadow-xl border-4 border-orange-300 max-w-md w-full text-center">
          <div className="mb-6 flex justify-center">
            <span className="text-6xl animate-bounce">ğŸ›’</span>
          </div>
          <h1 className="text-4xl font-black text-orange-500 mb-2 tracking-wide">è¶…å¸‚å¤§å†’éšª</h1>
          <p className="text-gray-500 mb-8 text-lg">æ‰¾å‡º 5 å€‹ä¸ä¸€æ¨£çš„å•†å“ï¼</p>
          
          <button 
            onClick={initGame}
            className="w-full bg-orange-400 hover:bg-orange-500 text-white text-2xl font-bold py-4 px-8 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3"
          >
            <Play size={32} fill="white" />
            é–‹å§‹éŠæˆ²
          </button>
        </div>
      </div>
    );
  }

  // 2. ç²å‹ç•«é¢
  if (gameState === 'won') {
    return (
      <div className="min-h-screen bg-yellow-50 flex flex-col items-center justify-center p-4 relative overflow-hidden">
        {/* å½©å¸¶èƒŒæ™¯æ•ˆæœ (ç°¡æ˜“æ¨¡æ“¬) */}
        <div className="absolute inset-0 opacity-10 pointer-events-none">
          {[...Array(20)].map((_, i) => (
            <div key={i} className="absolute text-4xl animate-pulse" style={{
              left: `${Math.random() * 100}%`,
              top: `${Math.random() * 100}%`,
              animationDelay: `${Math.random()}s`
            }}>âœ¨</div>
          ))}
        </div>

        <div className="bg-white p-8 rounded-3xl shadow-2xl border-4 border-yellow-400 max-w-md w-full text-center z-10 transform transition-all animate-in zoom-in duration-500">
          <Trophy size={80} className="mx-auto text-yellow-400 mb-6 drop-shadow-md animate-bounce" />
          <h2 className="text-4xl font-black text-slate-700 mb-4">å¤ªæ£’äº†ï¼</h2>
          <p className="text-xl text-gray-500 mb-8">ä½ æ‰¾åˆ°äº†æ‰€æœ‰ä¸åŒçš„å•†å“ï¼</p>
          
          <div className="grid grid-cols-4 gap-2 mb-8 bg-slate-50 p-4 rounded-xl">
             {/* é¡¯ç¤ºæ‰€æœ‰å­¸åˆ°çš„å–®å­—ä½œç‚ºå›é¡§ */}
             {VOCABULARY.map(v => (
               <div key={v.id} className="text-center">
                 <div className="text-2xl">{v.emoji}</div>
               </div>
             ))}
          </div>

          <button 
            onClick={initGame}
            className="w-full bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2"
          >
            <RefreshCw size={24} />
            å†ç©ä¸€æ¬¡
          </button>
        </div>
      </div>
    );
  }

  // 3. éŠæˆ²é€²è¡Œç•«é¢
  return (
    <div className="min-h-screen bg-yellow-50 flex flex-col items-center py-4 px-2 select-none">
      
      {/* é ‚éƒ¨è³‡è¨Šåˆ— */}
      <header className="w-full max-w-5xl flex justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-sm border-b-4 border-yellow-200">
        <div className="flex items-center gap-2">
           <div className="bg-orange-100 p-2 rounded-lg">
             <Sparkles className="text-orange-500" />
           </div>
           <div>
             <div className="text-xs text-gray-400 font-bold uppercase tracking-wider">é€²åº¦</div>
             <div className="text-2xl font-black text-orange-500 font-mono">
               {foundIndices.length} / 5
             </div>
           </div>
        </div>
        
        <h1 className="hidden md:block text-2xl font-bold text-slate-700 tracking-wider">
          è¶…å¸‚æ‰¾ç¢´ (Spot the Difference)
        </h1>

        <button 
          onClick={initGame}
          className="bg-slate-100 hover:bg-slate-200 p-3 rounded-xl transition text-slate-600"
          title="é‡æ–°é–‹å§‹"
        >
          <RefreshCw size={24} />
        </button>
      </header>

      {/* ä¸»è¦éŠæˆ²å€åŸŸï¼šRWD (æ‰‹æ©Ÿç›´æ’, æ¡Œæ©Ÿæ©«æ’) */}
      <div className="flex flex-col lg:flex-row gap-6 lg:gap-12 w-full max-w-5xl justify-center items-start">
        
        {/* å·¦å´ï¼šæ¨™æº–åœ– */}
        <div className="flex flex-col items-center">
          <div className="mb-2 bg-blue-100 text-blue-800 px-4 py-1 rounded-full text-sm font-bold flex items-center gap-1">
             <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
             åƒè€ƒåœ– (Look Here)
          </div>
          <div className="grid grid-cols-4 gap-2 p-3 bg-white rounded-2xl shadow-lg border-2 border-blue-100">
            {leftGrid.map((item, idx) => (
              <div 
                key={`${item.id}-${idx}`}
                className={`w-14 h-14 sm:w-20 sm:h-20 flex items-center justify-center text-3xl sm:text-4xl rounded-xl ${item.bg} opacity-90 cursor-default`}
              >
                {item.emoji}
              </div>
            ))}
          </div>
        </div>

        {/* å³å´ï¼šæ‰¾ç¢´åœ– (å¯äº’å‹•) */}
        <div className="flex flex-col items-center relative">
          <div className="mb-2 bg-red-100 text-red-800 px-4 py-1 rounded-full text-sm font-bold flex items-center gap-1">
             <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
             é»é€™è£¡æ‰¾ä¸åŒ! (Click Here)
          </div>
          
          <div className="grid grid-cols-4 gap-2 p-3 bg-white rounded-2xl shadow-[0_0_20px_rgba(0,0,0,0.1)] border-2 border-red-100 relative">
            {rightGrid.map((item, idx) => {
              const isFound = foundIndices.includes(idx);
              const isShaking = shakeIndex === idx;

              return (
                <button
                  key={`${item.id}-${idx}-right`}
                  onClick={() => handleGridClick(idx)}
                  className={`
                    w-14 h-14 sm:w-20 sm:h-20 flex items-center justify-center text-3xl sm:text-4xl rounded-xl 
                    transition-all duration-200 transform
                    ${item.bg}
                    ${isShaking ? 'animate-shake ring-4 ring-red-400 z-10' : ''}
                    ${!isFound ? 'hover:scale-105 hover:brightness-110 active:scale-95 cursor-pointer shadow-sm' : ''}
                    ${isFound ? 'ring-4 ring-green-400 opacity-100 scale-100 z-10' : ''}
                  `}
                  disabled={isFound}
                >
                  {item.emoji}
                  {isFound && (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/10 rounded-xl animate-in zoom-in duration-300">
                      <CheckCircle2 size={32} className="text-green-600 drop-shadow-lg" strokeWidth={3} />
                    </div>
                  )}
                </button>
              );
            })}
          </div>

          {/* éŒ¯èª¤æç¤º Floating Text */}
          {feedbackMsg && (
            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-20">
               <div className="bg-red-500 text-white px-6 py-3 rounded-full shadow-xl font-bold text-lg flex items-center gap-2 animate-bounce whitespace-nowrap">
                 <AlertCircle size={20} />
                 {feedbackMsg}
               </div>
            </div>
          )}
        </div>
      </div>

      {/* ç”Ÿè©å¡ Modal (æ‰¾åˆ°æ™‚å½ˆå‡º) */}
      {activeCard && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white rounded-[2rem] p-6 w-full max-w-sm shadow-2xl transform transition-all scale-100 border-4 border-yellow-300 relative overflow-hidden">
            {/* èƒŒæ™¯è£é£¾ */}
            <div className={`absolute top-0 left-0 w-full h-32 ${activeCard.bg} opacity-50 -z-10 rounded-t-[1.7rem]`}></div>
            
            <div className="flex flex-col items-center">
              <div className="w-32 h-32 flex items-center justify-center bg-white rounded-full shadow-lg mb-4 text-7xl border-4 border-white">
                {activeCard.emoji}
              </div>
              
              <h2 className="text-5xl font-black text-slate-800 mb-1">{activeCard.zh}</h2>
              <p className="text-xl text-slate-500 font-medium mb-6 font-mono">{activeCard.pinyin}</p>
              
              <div className="flex gap-3 w-full">
                <button 
                  onClick={() => speakText(activeCard.zh)}
                  className="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-600 font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2"
                >
                  <Volume2 size={24} />
                  è½ç™¼éŸ³
                </button>
                <button 
                  onClick={closeCard}
                  className="flex-1 bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-xl shadow-md transition transform active:scale-95"
                >
                  å¤ªå¥½äº†ï¼(OK)
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Tailwind è‡ªå®šç¾©å‹•ç•« Style */}
      <style>{`
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-8px) rotate(-5deg); }
          75% { transform: translateX(8px) rotate(5deg); }
        }
        .animate-shake {
          animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
      `}</style>
    </div>
  );
}